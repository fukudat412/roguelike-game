# ローグライク探索ゲーム - 開発ガイド

## プロジェクト概要

Webブラウザで動作するローグライク探索ゲーム。Elonaのような無限に遊べるゲーム性を目指して開発中。

### 技術スタック
- **言語**: TypeScript
- **ビルドツール**: Vite
- **レンダリング**: Canvas 2D API
- **状態管理**: イベント駆動アーキテクチャ（EventBus）
- **データ永続化**: LocalStorage

### 主要機能
- **ダンジョンタイプシステム**（4種類のダンジョン：洞窟、墓地、要塞、塔）
- **エリート敵システム**（★マーク付き強化版）
- **環境効果システム**（ダンジョン固有の特殊効果）
- ランダムマップ生成（部屋型、洞窟型、BSP分割型）
- ターン制戦闘システム
- スキルシステム（8種類のアクティブスキル）
- インベントリ・装備システム
- メタプログレッション（死亡後も引き継がれる永続アップグレード）
- デイリーチャレンジシステム
- ボスエンカウント
- 宝箱と戦利品システム

---

## ディレクトリ構造

```
src/
├── core/                      # コアシステム
│   ├── Game.ts               # メインゲームループと統合
│   ├── GameState.ts          # ゲーム状態管理
│   ├── Input.ts              # キーボード入力処理
│   ├── EventBus.ts           # イベント駆動システム
│   └── DailyChallenge.ts     # デイリーチャレンジ
│
├── renderer/                  # 描画システム
│   └── Renderer.ts           # Canvas描画抽象化
│
├── world/                     # マップ・ワールド
│   ├── Map.ts                # マップクラス（FOV、衝突判定、環境効果）
│   ├── World.ts              # 複数階層管理（ダンジョンタイプ統合）
│   ├── Tile.ts               # タイル定義
│   ├── DungeonType.ts        # ダンジョンタイプ・設定型定義
│   └── generators/           # マップ生成アルゴリズム
│       ├── RoomGenerator.ts  # 部屋型
│       ├── CaveGenerator.ts  # 洞窟型（セルオートマトン）
│       └── BSPGenerator.ts   # BSP分割型
│
├── entities/                  # エンティティ
│   ├── Entity.ts             # エンティティ基底クラス
│   ├── Player.ts             # プレイヤー
│   ├── Enemy.ts              # 敵
│   ├── Item.ts               # アイテム
│   ├── Stairs.ts             # 階段
│   ├── Shop.ts               # 商人
│   ├── Chest.ts              # 宝箱
│   └── components/           # コンポーネント
│       ├── Stats.ts          # ステータス（HP/MP/攻撃/防御）
│       ├── Position.ts       # 位置
│       ├── Inventory.ts      # インベントリ
│       └── Equipment.ts      # 装備
│
├── combat/                    # 戦闘システム
│   ├── CombatSystem.ts       # 戦闘処理
│   └── StatusEffect.ts       # ステータス効果（毒、麻痺等）
│
├── character/                 # キャラクター成長
│   ├── Skill.ts              # スキルシステム
│   └── MetaProgression.ts    # メタプログレッション
│
├── items/                     # アイテムシステム
│   └── ItemAffix.ts          # 接頭辞/接尾辞（炎の剣等）
│
├── ai/                        # AI
│   └── pathfinding/
│       └── AStar.ts          # A*パスファインディング
│
├── ui/                        # UI
│   ├── UIManager.ts          # UI統合管理
│   ├── MessageLog.ts         # メッセージログ
│   ├── InventoryUI.ts        # インベントリUI
│   ├── ShopUI.ts             # 店UI
│   ├── Minimap.ts            # ミニマップ
│   ├── MetaProgressionUI.ts  # メタ進行UI
│   └── DungeonSelectionUI.ts # ダンジョン選択UI
│
├── data/                      # ゲームデータ
│   ├── enemies.ts            # 敵データ
│   ├── items.ts              # アイテムデータ
│   ├── tiles.ts              # タイルデータ
│   └── dungeonConfigs.ts     # ダンジョン設定データ
│
└── utils/                     # ユーティリティ
    ├── Vector2D.ts           # 2Dベクトル
    ├── SaveManager.ts        # セーブ/ロード
    └── SoundManager.ts       # サウンド管理
```

---

## 主要システム詳細

### 1. ゲームループ (Game.ts)

```typescript
// 固定タイムステップ (60 FPS)
gameLoop() {
  update()    // ロジック更新
  render()    // 描画
}
```

**フロー**:
1. 入力処理 → プレイヤーアクション
2. ターン処理（プレイヤー → 敵）
3. 戦闘処理
4. UI更新
5. 描画

### 2. イベント駆動システム (EventBus.ts)

システム間の疎結合を実現。

**主要イベント**:
- `PLAYER_DAMAGE`: プレイヤーがダメージを受けた
- `ENEMY_DEATH`: 敵が死亡した
- `PLAYER_LEVEL_UP`: レベルアップ
- `COMBAT_HIT`: 戦闘ヒット
- `UI_UPDATE`: UI更新が必要
- `MESSAGE_LOG`: メッセージログに追加

### 3. マップ生成

3種類のアルゴリズムをランダムに選択：

1. **RoomGenerator**: シンプルな部屋＋通路
2. **CaveGenerator**: セルオートマトン（4-5-規則）
3. **BSPGenerator**: 空間を再帰的に分割

**FOV（視界）**: シャドウキャスティングアルゴリズム実装済み

### 4. 戦闘システム

**ダメージ計算式**:
```typescript
baseDamage = attacker.attack - defender.defense / 2
actualDamage = baseDamage * random(0.85, 1.15)
// クリティカル: luck / 100 の確率で2倍
```

**ステータス効果**:
- 毒（POISON）: 毎ターンダメージ
- 麻痺（PARALYSIS）: 行動不能
- 混乱（CONFUSION）: ランダム移動
- 再生（REGENERATION）: 毎ターン回復
- 強化/弱体（STRENGTH/WEAKNESS）: 攻撃力変化
- 加速/減速（SPEED_UP/SPEED_DOWN）: 速度変化

### 5. スキルシステム

全8種類のアクティブスキル：

| キー | スキル名 | 効果 | MP | CD |
|-----|---------|------|----|----|
| 1 | 強打 | 2倍ダメージ単体攻撃 | 10 | 3 |
| 3 | 範囲斬り | 周囲8マス全体攻撃 | 15 | 5 |
| 5 | 回復の祈り | HP 50回復 | 20 | 4 |
| 7 | ファイアボール | 遠距離範囲攻撃 | 25 | 6 |
| 9 | テレポート | ランダム移動 | 30 | 10 |
| Q | バーサーク | 攻撃力2倍（3ターン） | 20 | 8 |
| E | 氷の壁 | 周囲の敵を遅延 | 15 | 5 |
| R | ライフスティール | 攻撃＋HP吸収 | 18 | 4 |

### 6. メタプログレッションシステム

死亡後も引き継がれる永続アップグレード。

**メタポイント獲得源**:
- 敵撃破: 1pt（ボス: 50pt）
- 階層到達: 10pt/階層
- ゴールド獲得: 1pt/100G

**アップグレード種類**:
- 最大HP増加 (+10/レベル)
- 最大MP増加 (+5/レベル)
- 攻撃力増加 (+2/レベル)
- 防御力増加 (+1/レベル)
- 初期ゴールド (+50/レベル)

### 7. デイリーチャレンジ

毎日3つのランダムミッション。

**チャレンジタイプ**:
- 敵を倒す
- ボスを倒す
- 宝箱を開ける
- アイテムを収集する
- 階層に到達する
- ゴールドを獲得する

### 8. ダンジョンタイプシステム

ゲームの根幹となる複数ダンジョンシステム。

**4種類のダンジョン**:

| ダンジョン | 特徴 | 敵の種類 | マップ生成 | 環境効果 |
|-----------|------|----------|-----------|----------|
| 🦁 洞窟 | 野獣の巣窟 | 動物系（ネズミ、狼） | 洞窟型60% | 暗闇 (防御-10%) |
| 💀 墓地 | アンデッドの住処 | アンデッド系 | 部屋型50% | 死の瘴気 (HP-1/ターン) |
| 🏰 要塞 | 訓練された兵士 | 人間型（ゴブリン、オーク） | 部屋型70% | 戒厳令 (敵攻撃+15%) |
| 🗼 塔 | 魔法生物の巣 | 魔法生物（デーモン、ドラゴン） | BSP50% | 魔力の奔流 (MP+2/ターン) |

**エリート敵システム**:
- ダンジョンごとに異なる出現確率（15-30%）
- ステータス1.3-1.5倍、報酬2倍
- 名前に★マークを表示

**環境効果**:
- ダンジョン固有の効果が一定階層ごとに発動
- プレイヤーと敵の両方に影響
- 戦略的な深みを追加
- ターンを生き延びる

**特徴**:
- 日付ベースのシード値で同じ日は同じチャレンジ
- 完了時にメタポイント＋ゴールド報酬
- LocalStorageで永続化

### 8. アイテムシステム

**レア度**:
- Common（白）: 基本アイテム
- Uncommon（緑）: やや良い
- Rare（青）: レア
- Epic（紫）: エピック
- Legendary（橙）: 伝説

**接頭辞/接尾辞**: 「炎の剣」「氷結の鎧」等のランダム生成

---

## ゲームバランス調整履歴

### Phase 1（実装済み）
- 敵の出現数を調整（上限18体）
- レベルアップ報酬をレベルスケーリング
- ボス撃破時にMP回復＋全スキルCD解除

### Phase 2（実装済み）
- スキルを3種類→8種類に拡張
- 詳細なゲームオーバー統計画面（スコア計算）

### Phase 3（実装済み）
- デイリーチャレンジシステム追加

### Phase 3-2（未実装）
- 敵AIの改善（より高度な行動パターン）
- 装備バリエーションの追加

---

## 開発の進め方

### コーディング規約

1. **コメントは日本語**: すべてのクラス・メソッドに日本語コメント
2. **型安全**: TypeScriptの厳格モードを使用
3. **イベント駆動**: システム間通信はEventBusを使用
4. **データ駆動**: ゲームデータは`data/`ディレクトリに集約

### 新機能追加の手順

1. **計画**: 実装内容を`CLAUDE.md`に記載
2. **データ定義**: `data/`に必要なデータを追加
3. **コア実装**: 機能を実装
4. **イベント統合**: EventBusでイベントを発行/購読
5. **UI更新**: UIManagerに表示ロジック追加
6. **テスト**: ビルドして動作確認
7. **コミット**: 意味のある単位でcommit

### デバッグ機能

将来的に実装予定：
- FOV境界表示
- パスファインディング経路表示
- FPS表示
- チートコマンド（godMode、noClip、giveItem、teleport）

---

## 既知の課題

### パフォーマンス
- 敵が多い場合のパスファインディング負荷
- 大量のダメージ数字表示時のフレームドロップ

### ゲームバランス
- 一部のスキルが強すぎる/弱すぎる
- 後半階層の難易度カーブ

### UI/UX
- モバイル対応なし
- キー操作のチュートリアルがない
- セーブ/ロード機能が未実装（メタ進行のみ）

---

## 実装履歴

### Phase 1: MVP（基本システム）
- ✅ ゲームループと基盤構築
- ✅ マップ生成（3種類のアルゴリズム）
- ✅ プレイヤーとエンティティシステム
- ✅ 基本戦闘システム
- ✅ UI基盤

### Phase 2: コアゲームプレイ
- ✅ インベントリシステム
- ✅ 装備システム
- ✅ 消費アイテム
- ✅ 多階層ダンジョン
- ✅ 敵のバリエーション

### Phase 3: ゲーム性の拡充
- ✅ スキルシステム（8種類）
- ✅ メタプログレッション
- ✅ ボスエンカウント
- ✅ 宝箱システム
- ✅ ステータス効果
- ✅ デイリーチャレンジ（Phase 3-1）
- ✅ **複数ダンジョンシステム（Phase 3-2）**
  - 4種類のダンジョンタイプ
  - エリート敵システム
  - 環境効果システム
  - ダンジョン選択UI

---

## 今後の展望

### 短期目標
- [ ] セーブ/ロード機能の実装
- [ ] キー操作ガイドの追加
- [ ] Phase 5: メタプログレッションとダンジョンシステムの統合
  - ダンジョンごとのメタポイント履歴
  - ダンジョン固有のデイリーチャレンジ

### 中期目標
- [ ] クエストシステム
- [ ] キャラクタークラス（戦士、魔法使い等）
- [ ] スキルツリー
- [ ] より複雑なマップ（特殊部屋、トラップ）

### 長期目標
- [ ] マルチプレイヤー要素
- [ ] モバイル対応
- [ ] バイオームシステム（森、砂漠、氷原）
- [ ] エンドゲームコンテンツ

---

## 参考リソース

### マップ生成アルゴリズム
- [RogueBasin - Roguelike Development](http://www.roguebasin.com/)
- セルオートマトン: 4-5-規則（4隣接以下で壁、5以上で床）
- BSP分割: Binary Space Partitioning

### パスファインディング
- A*アルゴリズム（ヒューリスティック: マンハッタン距離）

### FOV
- シャドウキャスティングアルゴリズム

---

## 連絡先・貢献

プロジェクトリポジトリ: https://github.com/fukudat412/roguelike-game

バグ報告や機能提案はGitHub Issuesへお願いします。
